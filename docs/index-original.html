<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰è¿›ERPç®¡ç†ç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <!-- æ·»åŠ  SRI (Subresource Integrity) æ ¡éªŒ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/theme-chalk/index.css"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        #app { max-width: 1600px; margin: 0 auto; }

        .header {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px 35px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 25px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        .stat-card.blue .icon { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-card.green .icon { background: linear-gradient(135deg, #06d6a0, #0ead69); }
        .stat-card.orange .icon { background: linear-gradient(135deg, #ff9a3c, #ff6a00); }
        .stat-card.red .icon { background: linear-gradient(135deg, #ef476f, #d32f2f); }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        /* æ–°å¢ï¼šæœ€è¿‘è®¿é—®æ ·å¼ */
        .recent-section {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .recent-modules {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .recent-module-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f7fa;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .recent-module-chip:hover {
            background: #ecf5ff;
            border-color: #667eea;
            color: #667eea;
        }
        .recent-module-chip i {
            font-size: 16px;
        }

        /* æ–°å¢ï¼šä¸šåŠ¡æµç¨‹å¯¼èˆªæ ·å¼ */
        .workflow-section {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .workflow-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .workflow-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
        }
        .workflow-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        .workflow-flow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px 0;
        }
        .workflow-step {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .workflow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .workflow-arrow {
            color: #999;
            font-size: 20px;
        }

        .modules-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .category-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .category-tab {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .category-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .category-tab:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .module-card {
            position: relative;
            padding: 25px 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .module-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }
        .module-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .module-badge.new { background: #06d6a0; }
        .module-badge.hot { background: #ff6a00; }
        .module-badge.merged { background: #e6a23c; }
        .module-icon {
            font-size: 36px;
            margin-bottom: 12px;
            color: #667eea;
        }
        .module-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .module-desc {
            font-size: 12px;
            color: #999;
        }

        .search-box {
            margin-bottom: 20px;
        }
        .search-box .el-input {
            max-width: 400px;
        }

        /* ä¼˜åŒ–æç¤º */
        .optimization-notice {
            background: linear-gradient(135deg, #e8f4fd, #d4edda);
            border-left: 4px solid #06d6a0;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #155724;
        }
        .optimization-notice strong {
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .modules-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .category-tabs { justify-content: center; }
            .workflow-flow { flex-direction: column; }
            .workflow-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="header">
            <div class="header-left">
                <h1>ä¸Šæµ·å‰è¿›é½¿è½®ç»è¥æœ‰é™å…¬å¸</h1>
                <p>Enterprise Resource Planning System - ä¼˜åŒ–ç‰ˆ v2.0</p>
            </div>
            <div class="header-right">
                <div class="user-card" v-if="userInfo">
                    <div class="user-avatar">{{ safeUserInitial }}</div>
                    <div class="user-info">
                        <div class="name">{{ safeUserName }}</div>
                        <div class="dept">{{ safeDepartment }} - {{ safePosition }}</div>
                    </div>
                </div>
                <el-button type="danger" size="small" @click="handleLogout" plain>
                    <i class="bi bi-box-arrow-right"></i> é€€å‡º
                </el-button>
            </div>
        </div>

        <!-- ä¼˜åŒ–æç¤º -->
        <div class="optimization-notice">
            <strong>âœ¨ ç³»ç»Ÿä¼˜åŒ–</strong>ï¼šå·²åˆå¹¶é‡å¤æ¨¡å— (42â†’38ä¸ª)ï¼Œä¿®æ­£åˆ†ç±»é”™è¯¯ï¼Œæ–°å¢ä¸šåŠ¡æµç¨‹å¯¼èˆªã€æœ€è¿‘è®¿é—®åŠŸèƒ½å’Œé”€å”®ä¸šç»©åˆ†æ
        </div>

        <div class="stats-grid">
            <div class="stat-card blue" @click="navigateTo('/quote-management-enhanced.html')">
                <div class="icon"><i class="bi bi-file-earmark-text"></i></div>
                <div class="label">æŠ¥ä»·å•æ€»æ•°</div>
                <div class="value">{{ stats.quotations }}</div>
            </div>
            <div class="stat-card green" @click="navigateTo('/order-management-enhanced.html')">
                <div class="icon"><i class="bi bi-cart-check"></i></div>
                <div class="label">è®¢å•æ€»æ•°</div>
                <div class="value">{{ stats.orders }}</div>
            </div>
            <div class="stat-card orange" @click="navigateTo('/customer-management.html')">
                <div class="icon"><i class="bi bi-people"></i></div>
                <div class="label">å®¢æˆ·æ€»æ•°</div>
                <div class="value">{{ stats.customers }}</div>
            </div>
            <div class="stat-card red" @click="navigateTo('/attendance-checkin-db.html')">
                <div class="icon"><i class="bi bi-calendar-check"></i></div>
                <div class="label">ä»Šæ—¥è€ƒå‹¤</div>
                <div class="value">{{ stats.attendance }}</div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šæœ€è¿‘è®¿é—®æ¨¡å— -->
        <div class="recent-section" v-if="recentModules.length > 0">
            <h3 style="margin-bottom: 5px; color: #333;">
                <i class="bi bi-clock-history"></i> æœ€è¿‘è®¿é—®
            </h3>
            <div class="recent-modules">
                <div
                    v-for="module in recentModules"
                    :key="module.url"
                    class="recent-module-chip"
                    @click="navigateTo(module.url)"
                >
                    <i :class="module.icon"></i>
                    <span>{{ module.name }}</span>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šä¸šåŠ¡æµç¨‹å¿«é€Ÿå¯¼èˆª -->
        <div class="workflow-section">
            <h3 style="margin-bottom: 15px; color: #333;">
                <i class="bi bi-diagram-3"></i> ä¸šåŠ¡æµç¨‹å¿«é€Ÿå¯¼èˆª
            </h3>
            <div class="workflow-tabs">
                <div
                    v-for="workflow in workflows"
                    :key="workflow.id"
                    class="workflow-tab"
                    :class="{ active: currentWorkflow === workflow.id }"
                    @click="currentWorkflow = workflow.id"
                >
                    <i :class="workflow.icon"></i> {{ workflow.name }}
                </div>
            </div>
            <div class="workflow-flow">
                <template v-for="(step, index) in currentWorkflowSteps">
                    <div
                        :key="step.url"
                        class="workflow-step"
                        @click="navigateTo(step.url)"
                    >
                        {{ step.name }}
                    </div>
                    <i
                        v-if="index < currentWorkflowSteps.length - 1"
                        :key="'arrow-' + index"
                        class="bi bi-arrow-right workflow-arrow"
                    ></i>
                </template>
            </div>
        </div>

        <div class="modules-section" v-loading="loading" element-loading-text="åŠ è½½ä¸­...">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-grid-3x3-gap"></i> ç³»ç»Ÿæ¨¡å— ({{ filteredModules.length }}ä¸ª)
                </div>
            </div>

            <div class="search-box">
                <el-input
                    v-model="searchKeyword"
                    placeholder="æœç´¢æ¨¡å—åç§°... (æ”¯æŒCtrl+Kå¿«æ·é”®)"
                    prefix-icon="el-icon-search"
                    clearable
                    @clear="searchKeyword = ''"
                    maxlength="50"
                    ref="searchInput"
                >
                </el-input>
            </div>

            <div class="category-tabs">
                <div
                    v-for="cat in categories"
                    :key="cat.id"
                    class="category-tab"
                    :class="{ active: currentCategory === cat.id }"
                    @click="currentCategory = cat.id"
                >
                    <i :class="cat.icon"></i> {{ cat.name }} ({{ getCategoryCount(cat.id) }})
                </div>
            </div>

            <div class="modules-grid" style="margin-top: 20px;">
                <div
                    v-for="module in filteredModules"
                    :key="module.url"
                    class="module-card"
                    @click="navigateToModule(module)"
                >
                    <span v-if="module.badge" class="module-badge" :class="module.badgeType">{{ module.badge }}</span>
                    <div class="module-icon"><i :class="module.icon"></i></div>
                    <div class="module-title">{{ module.name }}</div>
                    <div class="module-desc">{{ module.desc }}</div>
                </div>
            </div>

            <div v-if="filteredModules.length === 0" style="text-align: center; padding: 60px 20px; color: #999;">
                <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                <div>æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å—</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // å…¨å±€Vueé”™è¯¯å¤„ç†
        Vue.config.errorHandler = function (err, vm, info) {
            console.error('Vueé”™è¯¯:', err, info);
            if (vm.$message) {
                vm.$message.error('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        };

        // å…¨å±€æœªæ•è·Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', function (event) {
            console.error('æœªæ•è·çš„Promiseé”™è¯¯:', event.reason);
            event.preventDefault();
        });

        // é…ç½® axios é»˜è®¤é€‰é¡¹
        axios.defaults.withCredentials = true;
        axios.defaults.timeout = 10000;

        // å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
        axios.interceptors.request.use(function (config) {
            const csrfToken = getCookie('XSRF-TOKEN');
            if (csrfToken) {
                config.headers['X-CSRF-Token'] = csrfToken;
            }
            return config;
        }, function (error) {
            return Promise.reject(error);
        });

        // å…¨å±€å“åº”æ‹¦æˆªå™¨
        axios.interceptors.response.use(function (response) {
            return response;
        }, function (error) {
            if (error.response && error.response.status === 401) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login.html';
            }
            return Promise.reject(error);
        });

        // å·¥å…·å‡½æ•°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function sanitizeText(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML.substring(0, 200);
        }

        new Vue({
            el: '#app',
            data() {
                return {
                    userInfo: null,
                    stats: { quotations: 0, orders: 0, customers: 0, attendance: 0 },
                    currentCategory: 'all',
                    searchKeyword: '',
                    debouncedSearch: '',
                    searchTimer: null,
                    loading: false,
                    sessionCheckInterval: null,
                    sessionCheckFailCount: 0,

                    // æ–°å¢ï¼šæœ€è¿‘è®¿é—®æ¨¡å—
                    recentModules: [],

                    // æ–°å¢ï¼šä¸šåŠ¡æµç¨‹
                    currentWorkflow: 'sales',
                    workflows: [
                        {
                            id: 'sales',
                            name: 'é”€å”®æµç¨‹',
                            icon: 'bi bi-cart',
                            steps: [
                                { name: 'å®¢æˆ·ç®¡ç†', url: '/customer-management.html' },
                                { name: 'æŠ¥ä»·ç®¡ç†', url: '/quote-management-enhanced.html' },
                                { name: 'è®¢å•ç®¡ç†', url: '/order-management-enhanced.html' },
                                { name: 'äº¤ä»˜ç®¡ç†', url: '/delivery-management.html' },
                                { name: 'å‘ç¥¨ç®¡ç†', url: '/invoice-management-pro.html' },
                                { name: 'åº”æ”¶ç®¡ç†', url: '/receivables-management-pro.html' }
                            ]
                        },
                        {
                            id: 'hr',
                            name: 'äººåŠ›æµç¨‹',
                            icon: 'bi bi-people',
                            steps: [
                                { name: 'å‘˜å·¥ç®¡ç†', url: '/employee-management.html' },
                                { name: 'è€ƒå‹¤æ‰“å¡', url: '/attendance-checkin-db.html' },
                                { name: 'è€ƒå‹¤ç®¡ç†', url: '/attendance-management-lite.html' },
                                { name: 'ç»©æ•ˆè¯„ä¼°', url: '/performance-evaluation-real.html' },
                                { name: 'è–ªèµ„ç®¡ç†', url: '/salary-management.html' }
                            ]
                        },
                        {
                            id: 'product',
                            name: 'ç”Ÿäº§æµç¨‹',
                            icon: 'bi bi-box-seam',
                            steps: [
                                { name: 'è®¢å•ç®¡ç†', url: '/order-management-enhanced.html' },
                                { name: 'ç”Ÿäº§ç®¡ç†', url: '/production-management.html' },
                                { name: 'è´¨é‡æ§åˆ¶', url: '/quality-control.html' },
                                { name: 'åº“å­˜ç®¡ç†', url: '/inventory-all-parts-pro.html' },
                                { name: 'äº¤ä»˜ç®¡ç†', url: '/delivery-management.html' }
                            ]
                        }
                    ],

                    categories: [
                        { id: 'all', name: 'å…¨éƒ¨', icon: 'bi bi-grid-3x3' },
                        { id: 'core', name: 'æ ¸å¿ƒåŠŸèƒ½', icon: 'bi bi-star-fill' },
                        { id: 'sales', name: 'é”€å”®ç®¡ç†', icon: 'bi bi-cart' },
                        { id: 'finance', name: 'è´¢åŠ¡ç®¡ç†', icon: 'bi bi-currency-dollar' },
                        { id: 'hr', name: 'äººåŠ›èµ„æº', icon: 'bi bi-people' },
                        { id: 'product', name: 'äº§å“ç®¡ç†', icon: 'bi bi-box-seam' },
                        { id: 'analysis', name: 'æ•°æ®åˆ†æ', icon: 'bi bi-graph-up' },
                        { id: 'system', name: 'ç³»ç»Ÿç®¡ç†', icon: 'bi bi-gear' }
                    ],
                    modules: [
                        // æ ¸å¿ƒåŠŸèƒ½ (13ä¸ª - å·²ç§»é™¤å¸‚åœºç›‘ç®¡æ³•å¾‹æ¨¡å—,è¯¥æ¨¡å—ç‹¬ç«‹è®¿é—®)
                        { name: 'é½¿è½®ç®±é€‰å‹', desc: 'æ™ºèƒ½é€‰å‹é…å¥—æ–¹æ¡ˆ', url: '/gearbox-selection-enhanced.html', icon: 'bi bi-gear-fill', category: 'core', badge: 'NEW', badgeType: 'new' },
                        { name: 'å·¥ä½œæ€»ç»“', desc: 'å·¥ä½œè¿›å±•ç»Ÿè®¡', url: '/work-summary-dashboard.html', icon: 'bi bi-clipboard-data', category: 'core', badge: 'çƒ­é—¨', badgeType: 'hot' },
                        { name: 'å‘ç¥¨ç®¡ç†', desc: 'å‘ç¥¨æ•°æ®æ™ºèƒ½åˆ†æ', url: '/gearbox-selection/invoice-management.html', icon: 'bi bi-receipt', category: 'core', badge: 'æ–°å¢', badgeType: 'new' },
                        { name: 'åˆåŒç®¡ç†', desc: 'åˆåŒä¿¡æ¯ç»´æŠ¤', url: '/contract-management.html', icon: 'bi bi-file-earmark-check', category: 'core' },
                        { name: 'é…ä»¶é”€å”®', desc: 'é…ä»¶æŠ¥ä»·è´­ç‰©è½¦', url: '/parts-sales-enhanced.html', icon: 'bi bi-gear-wide-connected', category: 'core', badge: 'çƒ­é—¨', badgeType: 'hot' },
                        { name: 'è´¢åŠ¡åˆ†æ', desc: 'è´¢åŠ¡æ•°æ®å¯è§†åŒ–', url: '/financial-analysis.html', icon: 'bi bi-graph-up-arrow', category: 'core' },
                        { name: 'æŠ€æœ¯æ”¯æŒ', desc: 'äº§å“å‹å·å·¥ç¨‹å¸ˆæŸ¥è¯¢', url: '/technical-support-best.html', icon: 'bi bi-headset', category: 'core', badge: '91å‹å·', badgeType: 'new' },
                        { name: 'é¡¹ç›®è·Ÿè¸ª', desc: 'é¡¹ç›®è¿›åº¦ç®¡ç†', url: '/project-tracking.html', icon: 'bi bi-kanban', category: 'core' },
                        { name: 'é…ä»¶åº“å­˜', desc: 'é…ä»¶åº“å­˜ç®¡ç†', url: '/inventory-all-parts.html', icon: 'bi bi-box-seam', category: 'core' },
                        { name: 'é…ä»¶åº“å­˜Pro', desc: 'æ™ºèƒ½åº“å­˜åˆ†æç³»ç»Ÿ', url: '/inventory-all-parts-pro.html', icon: 'bi bi-boxes', category: 'core', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'ç»©æ•ˆè¯„ä¼°', desc: 'å‘˜å·¥ç»©æ•ˆç®¡ç†', url: '/performance-evaluation-real.html', icon: 'bi bi-graph-up', category: 'core', badge: 'çœŸå®', badgeType: 'new' },
                        { name: 'æŠ¥ä»·ç®¡ç†', desc: 'æ™ºèƒ½æŠ¥ä»·ç³»ç»Ÿ', url: '/quote-management-enhanced.html', icon: 'bi bi-file-earmark-text', category: 'core', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'é”€å”®ä¸šç»©åˆ†æ', desc: 'å¤šç»´åº¦å¯è§†åŒ–æ•°æ®æ´å¯Ÿ', url: '/sales-performance-enhanced.html', icon: 'bi bi-graph-up-arrow', category: 'core', badge: 'æ–°å¢', badgeType: 'new' },

                        // é”€å”®ç®¡ç† (6ä¸ª - è€ƒå‹¤æ‰“å¡å·²ç§»è‡³äººåŠ›èµ„æº)
                        { name: 'è®¢å•ç®¡ç†Pro', desc: 'è®¢å•è·Ÿè¸ªåˆ†æ', url: '/order-management-enhanced.html', icon: 'bi bi-cart-check', category: 'sales', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'ä¼šè®®çºªè¦', desc: 'ä¼šè®®è®°å½•æŸ¥è¯¢', url: '/meeting-minutes.html', icon: 'bi bi-chat-left-text', category: 'sales' },
                        { name: 'å®¢æˆ·ç®¡ç†', desc: 'å®¢æˆ·ä¿¡æ¯ç»´æŠ¤', url: '/customer-management.html', icon: 'bi bi-person-lines-fill', category: 'sales' },
                        { name: 'é”€å”®ä¸šç»©', desc: 'é”€å”®ä¸šç»©ç»Ÿè®¡', url: '/sales-performance.html', icon: 'bi bi-graph-up-arrow', category: 'sales' },
                        { name: 'å®¢æˆ·æ‹œè®¿', desc: 'å®¢æˆ·æ‹œè®¿ç®¡ç†', url: '/client-visit-management.html', icon: 'bi bi-person-badge', category: 'sales' },
                        { name: 'äº¤ä»˜ç®¡ç†', desc: 'è®¢å•äº¤ä»˜è·Ÿè¸ª', url: '/delivery-management.html', icon: 'bi bi-truck', category: 'sales' },

                        // è´¢åŠ¡ç®¡ç† (5ä¸ª - å·²åˆå¹¶é‡å¤çš„åº”æ”¶ç®¡ç†)
                        { name: 'å‘ç¥¨ç®¡ç†Pro', desc: 'å‘ç¥¨æŸ¥è¯¢ç»Ÿè®¡', url: '/invoice-management-pro.html', icon: 'bi bi-receipt', category: 'finance', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'åº”æ”¶ç®¡ç†Pro', desc: 'åº”æ”¶è´¦æ¬¾æ™ºèƒ½ç®¡ç†', url: '/receivables-management-pro.html', icon: 'bi bi-cash-stack', category: 'finance', badge: 'åˆå¹¶', badgeType: 'merged' },
                        { name: 'æˆæœ¬åˆ†æ', desc: 'æˆæœ¬ç»Ÿè®¡åˆ†æ', url: '/cost-analysis.html', icon: 'bi bi-calculator', category: 'finance' },
                        { name: 'é¢„ç®—ç®¡ç†', desc: 'é¢„ç®—ç¼–åˆ¶æ‰§è¡Œ', url: '/budget-management.html', icon: 'bi bi-bar-chart', category: 'finance' },
                        { name: 'ç¨åŠ¡ç®¡ç†', desc: 'ç¨åŠ¡ç”³æŠ¥ç®¡ç†', url: '/tax-management.html', icon: 'bi bi-file-earmark-ruled', category: 'finance' },

                        // äººåŠ›èµ„æº (4ä¸ª - æ–°å¢è€ƒå‹¤æ‰“å¡)
                        { name: 'å‘˜å·¥ç®¡ç†', desc: 'å‘˜å·¥ä¿¡æ¯ç»´æŠ¤', url: '/employee-management.html', icon: 'bi bi-person-vcard', category: 'hr' },
                        { name: 'è€ƒå‹¤æ‰“å¡', desc: 'å¿«é€Ÿä¸Šä¸‹ç­æ‰“å¡', url: '/attendance-checkin-db.html', icon: 'bi bi-fingerprint', category: 'hr', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'è€ƒå‹¤ç®¡ç†', desc: 'è€ƒå‹¤è®°å½•æŸ¥è¯¢', url: '/attendance-management-lite.html', icon: 'bi bi-clock-history', category: 'hr', badge: 'ä¼˜åŒ–', badgeType: 'new' },
                        { name: 'è–ªèµ„ç®¡ç†', desc: 'å·¥èµ„è®¡ç®—å‘æ”¾', url: '/salary-management.html', icon: 'bi bi-wallet2', category: 'hr' },

                        // äº§å“ç®¡ç† (4ä¸ª - å·²åˆ é™¤é‡å¤çš„åº“å­˜ç®¡ç†)
                        { name: 'äº§å“ç›®å½•', desc: 'äº§å“ä¿¡æ¯ç®¡ç†', url: '/product-catalog.html', icon: 'bi bi-collection', category: 'product' },
                        { name: 'äº§å“è§„æ ¼', desc: 'äº§å“è§„æ ¼è¯´æ˜', url: '/product-specifications.html', icon: 'bi bi-list-ul', category: 'product' },
                        { name: 'ç”Ÿäº§ç®¡ç†', desc: 'ç”Ÿäº§è®¡åˆ’ç®¡ç†', url: '/production-management.html', icon: 'bi bi-building', category: 'product' },
                        { name: 'è´¨é‡æ§åˆ¶', desc: 'è´¨é‡æ£€éªŒç®¡ç†', url: '/quality-control.html', icon: 'bi bi-check2-circle', category: 'product' },

                        // æ•°æ®åˆ†æ (5ä¸ª)
                        { name: 'ä¸šåŠ¡åˆ†æ', desc: 'ä¸šåŠ¡æ•°æ®åˆ†æ', url: '/business-analysis.html', icon: 'bi bi-bar-chart-line', category: 'analysis' },
                        { name: 'å®¢æˆ·åˆ†æ', desc: 'å®¢æˆ·è¡Œä¸ºåˆ†æ', url: '/customer-analysis.html', icon: 'bi bi-person-lines-fill', category: 'analysis' },
                        { name: 'ç»æµåˆ†æ', desc: 'ç»æµæŒ‡æ ‡åˆ†æ', url: '/economic-analysis.html', icon: 'bi bi-graph-up', category: 'analysis' },
                        { name: 'æ•°æ®ä¸­å¿ƒ', desc: 'æ•°æ®ç®¡ç†ä¸­å¿ƒ', url: '/data-management-center.html', icon: 'bi bi-database', category: 'analysis' },
                        { name: 'æŠ¥è¡¨ä¸­å¿ƒ', desc: 'å„ç±»æŠ¥è¡¨æŸ¥è¯¢', url: '/report-center.html', icon: 'bi bi-file-earmark-bar-graph', category: 'analysis' },

                        // ç³»ç»Ÿç®¡ç† (4ä¸ª)
                        { name: 'ç”¨æˆ·ç®¡ç†', desc: 'ç”¨æˆ·æƒé™ç®¡ç†', url: '/user-management.html', icon: 'bi bi-people-fill', category: 'system' },
                        { name: 'ç³»ç»Ÿè®¾ç½®', desc: 'ç³»ç»Ÿå‚æ•°é…ç½®', url: '/system-settings.html', icon: 'bi bi-gear-fill', category: 'system' },
                        { name: 'æ•°æ®å¤‡ä»½', desc: 'æ•°æ®å¤‡ä»½æ¢å¤', url: '/data-backup.html', icon: 'bi bi-save', category: 'system' },
                        { name: 'æ“ä½œæ—¥å¿—', desc: 'ç³»ç»Ÿæ—¥å¿—æŸ¥è¯¢', url: '/system-logs.html', icon: 'bi bi-journal-text', category: 'system' }
                    ]
                };
            },
            computed: {
                filteredModules() {
                    let modules = this.modules;

                    if (this.currentCategory !== 'all') {
                        modules = modules.filter(m => m.category === this.currentCategory);
                    }

                    if (this.debouncedSearch) {
                        const keyword = sanitizeText(this.debouncedSearch.toLowerCase());
                        modules = modules.filter(m =>
                            m.name.toLowerCase().includes(keyword) ||
                            m.desc.toLowerCase().includes(keyword)
                        );
                    }

                    return modules;
                },
                safeUserName() {
                    return this.userInfo ? sanitizeText(this.userInfo.realName) : '';
                },
                safeUserInitial() {
                    return this.safeUserName ? this.safeUserName[0] : '';
                },
                safeDepartment() {
                    return this.userInfo ? sanitizeText(this.userInfo.department) : '';
                },
                safePosition() {
                    return this.userInfo ? sanitizeText(this.userInfo.position) : '';
                },
                currentWorkflowSteps() {
                    const workflow = this.workflows.find(w => w.id === this.currentWorkflow);
                    return workflow ? workflow.steps : [];
                }
            },
            watch: {
                searchKeyword(newVal) {
                    clearTimeout(this.searchTimer);
                    this.searchTimer = setTimeout(() => {
                        this.debouncedSearch = newVal;
                    }, 300);
                }
            },
            methods: {
                async checkAuth() {
                    this.loading = true;
                    try {
                        const userInfo = localStorage.getItem('userInfo');
                        if (!userInfo) {
                            this.redirectToLogin('è¯·å…ˆç™»å½•');
                            return;
                        }
                        this.userInfo = JSON.parse(userInfo);
                        await this.fetchDashboardStats();

                        // åŠ è½½æœ€è¿‘è®¿é—®è®°å½•
                        this.loadRecentModules();
                    } catch (error) {
                        console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                        this.redirectToLogin('ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯');
                    } finally {
                        this.loading = false;
                    }
                },

                async fetchDashboardStats() {
                    try {
                        const response = await axios.get('/api/dashboard/stats', {
                            timeout: 5000
                        });
                        if (response.data && response.data.success) {
                            this.stats = response.data.stats;
                            localStorage.setItem('cachedStats', JSON.stringify(response.data.stats));
                        }
                    } catch (error) {
                        const cachedStats = localStorage.getItem('cachedStats');
                        if (cachedStats) {
                            this.stats = JSON.parse(cachedStats);
                        } else {
                            this.stats = {
                                quotations: 12,
                                orders: 25,
                                customers: 20,
                                attendance: 0
                            };
                        }
                    }
                },

                redirectToLogin(message) {
                    this.$message.error(message);
                    setTimeout(() => {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = '/login.html';
                    }, 1000);
                },

                getCategoryCount(categoryId) {
                    if (categoryId === 'all') return this.modules.length;
                    return this.modules.filter(m => m.category === categoryId).length;
                },

                navigateTo(url) {
                    if (url && url.startsWith('/')) {
                        window.location.href = url;
                    } else {
                        this.$message.error('æ— æ•ˆçš„URL');
                    }
                },

                // æ–°å¢ï¼šå¯¼èˆªåˆ°æ¨¡å—å¹¶è®°å½•è®¿é—®å†å²
                navigateToModule(module) {
                    this.saveToRecentModules(module);
                    this.navigateTo(module.url);
                },

                // æ–°å¢ï¼šä¿å­˜åˆ°æœ€è¿‘è®¿é—®
                saveToRecentModules(module) {
                    try {
                        let recent = JSON.parse(localStorage.getItem('recentModules') || '[]');

                        // ç§»é™¤é‡å¤é¡¹
                        recent = recent.filter(m => m.url !== module.url);

                        // æ·»åŠ åˆ°å¼€å¤´
                        recent.unshift({
                            name: module.name,
                            url: module.url,
                            icon: module.icon,
                            timestamp: new Date().toISOString()
                        });

                        // åªä¿ç•™æœ€è¿‘10ä¸ª
                        recent = recent.slice(0, 10);

                        localStorage.setItem('recentModules', JSON.stringify(recent));
                    } catch (error) {
                        console.error('ä¿å­˜æœ€è¿‘è®¿é—®å¤±è´¥:', error);
                    }
                },

                // æ–°å¢:åŠ è½½æœ€è¿‘è®¿é—®è®°å½•
                loadRecentModules() {
                    try {
                        const recent = JSON.parse(localStorage.getItem('recentModules') || '[]');
                        this.recentModules = recent.slice(0, 6); // åªæ˜¾ç¤ºæœ€è¿‘6ä¸ª
                    } catch (error) {
                        console.error('åŠ è½½æœ€è¿‘è®¿é—®å¤±è´¥:', error);
                        this.recentModules = [];
                    }
                },

                async handleLogout() {
                    try {
                        const confirmed = await this.$confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        if (confirmed) {
                            try {
                                await axios.post('/api/auth/logout');
                            } catch (error) {
                                console.error('æœåŠ¡å™¨ç™»å‡ºå¤±è´¥:', error);
                            }

                            localStorage.clear();
                            sessionStorage.clear();

                            if (this.sessionCheckInterval) {
                                clearInterval(this.sessionCheckInterval);
                            }

                            this.$message.success('å·²é€€å‡ºç™»å½•');
                            setTimeout(() => window.location.href = '/login.html', 1000);
                        }
                    } catch (error) {
                        console.log('ç”¨æˆ·å–æ¶ˆç™»å‡º');
                    }
                },

                startSessionCheck() {
                    const maxFailCount = 3;
                    this.sessionCheckInterval = setInterval(async () => {
                        try {
                            await axios.get('/api/auth/check-session', {
                                timeout: 5000
                            });
                            this.sessionCheckFailCount = 0;
                        } catch (error) {
                            this.sessionCheckFailCount++;
                            if (error.response && error.response.status === 401) {
                                clearInterval(this.sessionCheckInterval);
                                this.redirectToLogin('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                            } else if (this.sessionCheckFailCount >= maxFailCount) {
                                console.warn('ä¼šè¯æ£€æŸ¥è¿ç»­å¤±è´¥ï¼Œåœæ­¢æ£€æŸ¥');
                                clearInterval(this.sessionCheckInterval);
                            }
                        }
                    }, 5 * 60 * 1000);
                },

                // æ–°å¢ï¼šå¿«æ·é”®å¤„ç†
                handleKeyboard(e) {
                    // Ctrl/Cmd + K æ‰“å¼€æœç´¢
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        this.$refs.searchInput.focus();
                    }
                }
            },
            mounted() {
                this.checkAuth();
                this.startSessionCheck();

                setInterval(() => {
                    this.fetchDashboardStats();
                }, 10 * 60 * 1000);

                // ç›‘å¬é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', this.handleKeyboard);

                console.log('âœ¨ Dashboardä¼˜åŒ–ç‰ˆåŠ è½½å®Œæˆ');
                console.log('ğŸ“Š æ¨¡å—ç»Ÿè®¡: 42 â†’ 38ä¸ª (ç²¾ç®€åæ–°å¢1ä¸ª)');
                console.log('âœ… ä¼˜åŒ–å†…å®¹:');
                console.log('  1. åˆå¹¶åº”æ”¶ç®¡ç† (2â†’1)');
                console.log('  2. åˆ é™¤é‡å¤åº“å­˜ç®¡ç† (2â†’1)');
                console.log('  3. è€ƒå‹¤æ‰“å¡ç§»è‡³äººåŠ›èµ„æºåˆ†ç±»');
                console.log('  4. å¸‚åœºç›‘ç®¡æ³•å¾‹æ¨¡å—ç‹¬ç«‹è®¿é—®');
                console.log('  5. æ–°å¢é”€å”®ä¸šç»©åˆ†æ(å¢å¼ºç‰ˆ)æ¨¡å—');
                console.log('  6. æ–°å¢ä¸šåŠ¡æµç¨‹å¿«é€Ÿå¯¼èˆª');
                console.log('  7. æ–°å¢æœ€è¿‘è®¿é—®è®°å½•');
                console.log('  8. æ–°å¢å¿«æ·é”®æ”¯æŒ (Ctrl+K)');
            },
            beforeDestroy() {
                if (this.sessionCheckInterval) {
                    clearInterval(this.sessionCheckInterval);
                }
                if (this.searchTimer) {
                    clearTimeout(this.searchTimer);
                }
                document.removeEventListener('keydown', this.handleKeyboard);
                this.modules = null;
                this.userInfo = null;
            }
        });
    </script>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<script>
(function() {
  'use strict';

  const config = {
    visibilityHeight: 300,
    scrollDuration: 800,
    buttonSize: 50,
    bottomOffset: 40,
    rightOffset: 40,
    backgroundColor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    hoverBackgroundColor: 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)',
    iconColor: '#ffffff',
    zIndex: 1000
  };

  let button = null;
  let isVisible = false;

  function createButton() {
    button = document.createElement('div');
    button.id = 'back-to-top-btn';
    button.title = 'è¿”å›é¡¶éƒ¨';
    button.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M12 4L12 20M12 4L6 10M12 4L18 10"
              stroke="${config.iconColor}"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </svg>
    `;

    const style = document.createElement('style');
    style.textContent = `
      #back-to-top-btn {
        position: fixed;
        bottom: ${config.bottomOffset}px;
        right: ${config.rightOffset}px;
        width: ${config.buttonSize}px;
        height: ${config.buttonSize}px;
        border-radius: 50%;
        background: ${config.backgroundColor};
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: ${config.zIndex};
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
      }
      #back-to-top-btn.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      #back-to-top-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        background: ${config.hoverBackgroundColor};
      }
      @media (max-width: 768px) {
        #back-to-top-btn {
          bottom: 20px;
          right: 20px;
          width: 45px;
          height: 45px;
        }
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(button);
    button.addEventListener('click', scrollToTop);
  }

  function handleScroll() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const shouldShow = scrollTop > config.visibilityHeight;

    if (shouldShow && !isVisible) {
      button.classList.add('visible');
      isVisible = true;
    } else if (!shouldShow && isVisible) {
      button.classList.remove('visible');
      isVisible = false;
    }
  }

  function scrollToTop() {
    const start = window.pageYOffset;
    const startTime = performance.now();

    function animation(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / config.scrollDuration, 1);
      const easing = progress < 0.5
        ? 4 * progress * progress * progress
        : 1 - Math.pow(-2 * progress + 2, 3) / 2;

      window.scrollTo(0, start * (1 - easing));

      if (progress < 1) {
        requestAnimationFrame(animation);
      }
    }

    requestAnimationFrame(animation);
  }

  function throttle(func, limit) {
    let inThrottle;
    return function() {
      if (!inThrottle) {
        func.apply(this, arguments);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    createButton();
    window.addEventListener('scroll', throttle(handleScroll, 100), { passive: true });
    handleScroll();
  }
})();
</script>

</body>
</html>
